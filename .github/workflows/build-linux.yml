name: Build Linux

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      architecture:
        type: string
        description: 'Architecture to build'
        required: true
        default: 'x64'
      version:
        type: string
        description: 'Version to build'
        required: true

env:
  TINY_XML_2_VERSION: "10.1.0"
  MONGOOSE_VERSION: "7.20"

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true

    - id: python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ ENV.PYTHON_VERSION }}
        architecture: ${{ inputs.architecture }}
        cache-dependency-path: 'build/python/requirements.txt'
        cache: 'pip'

    - uses: actions/setup-node@v6
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    - id: build-web
      working-directory: web
      run: |
        npm install
        npm run build

    - name: make dirs
      run: |
        mkdir -p tmp/nscp
      shell: bash

    - name: setup python dependencies
      shell: bash
      run: |
        pip3 install -r build/python/requirements.txt

    - id: tinyxml2
      uses: ./.github/actions/tinyxml2
      with:
        version: ${{ ENV.TINY_XML_2_VERSION }}

    - id: mongoose
      uses: ./.github/actions/mongoose
      with:
        version: ${{ ENV.MONGOOSE_VERSION }}

    - name: Install boost
      run: |
        sudo apt-get update
        sudo apt-get install -y libboost-all-dev libgtest-dev protobuf-compiler libprotobuf-dev openssl libssl-dev libgmock-dev libcrypto++-dev

    - uses: DamianReeves/write-file-action@master
      name: Write NSClient++ cmake config
      with:
        path: tmp/nscp/build.cmake
        contents: |
            SET(LIBRARY_ROOT_FOLDER	"${{ env.GITHUB_WORKSPACE }}")
            SET(NSCP_BOOST_PYTHON_VERSION "python312")
            SET(TINY_XML2_SOURCE_DIR "${{ steps.tinyxml2.outputs.path_unix }}")
            set(MONGOOSE_SOURCE_DIR "${{ steps.mongoose.outputs.path_unix }}")
            set(CHECK_NSCLIENT_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}")
            set(USE_STATIC_RUNTIME OFF)

    - uses: actions/download-artifact@v7
      with:
        name: check_nsclient-linux-${{ inputs.architecture }}

    - name: CMake (NSCP)
      working-directory: tmp/nscp
      run: |
        cmake ../.. -D BUILD_VERSION=${{ inputs.version }} -D CPACK_GENERATOR=DEB -DCMAKE_BUILD_TYPE=Release

    - name: Build nsclient
      working-directory: tmp/nscp
      run: |
        make

    - name: CPack
      working-directory: tmp/nscp
      run: |
        cpack -G DEB

    - name: rename dist files
      run: |
        mv check_nsclient check_nsclient-${{ inputs.version }}-ubuntu-x64
        mv tmp/nscp/NSCP-${{ inputs.version }}-amd64.deb NSCP-${{ inputs.version }}-amd64.deb
      shell: bash

    - name: Test DEB package installation (Ubuntu)
      run: |
        docker run --rm -v ${{ github.workspace }}:/workspace ubuntu:latest bash -c "
          apt-get update && \
          apt-get install -y /workspace/NSCP-${{ inputs.version }}-amd64.deb && \
          nscp settings --load-all --list --add-defaults
        "

    - uses: actions/upload-artifact@v6
      with:
        name: NSCP-${{ inputs.version }}-ubuntu-x64
        path: |
          check_nsclient-${{ inputs.version }}-ubuntu-x64
          NSCP-${{ inputs.version }}-amd64.deb
        if-no-files-found: error

    - name: Run tests
      working-directory: tmp/nscp
      run: |
        ctest --output-on-failure -C Release



  integration-tests:
    runs-on: ubuntu-latest
    needs: build-deb

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - id: python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ ENV.PYTHON_VERSION }}
          architecture: ${{ inputs.architecture }}
          cache-dependency-path: 'build/python/requirements.txt'
          cache: 'pip'

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - uses: actions/download-artifact@v7
        with:
          name: NSCP-${{ inputs.version }}-ubuntu-x64

      - shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-protobuf
          sudo apt-get install -y ./NSCP-${{ inputs.version }}-amd64.deb

      - name: Acceptance tests
        run: |
          sudo cp -r scripts/* /usr/lib/nsclient/scripts
          sudo nscp nrpe install --certificate --verify none
          ./tests/acceptance-tests.sh

      - name: Run rest tests
        uses: ./.github/actions/rest-test

      # TODO: Disabled for now due to issues with docker on windows runners
      #- name: Run NRPE tests
      #  working-directory: tmp/nscp
      #  run: |
      #    ..\..\tests\nrpe\run-test.bat

  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:42

    steps:
    - name: Install build dependencies
      run: |
        dnf install -y \
          git \
          cmake \
          gcc-c++ \
          make \
          rpm-build \
          boost-devel \
          boost-static \
          gtest-devel \
          gmock-devel \
          protobuf-compiler \
          protobuf-devel \
          openssl-devel \
          python3 \
          python3-pip \
          python3-devel \
          cryptopp-devel \
          nodejs \
          npm \
          lua-devel

    - uses: actions/checkout@v6
      with:
        submodules: true

    - name: make dirs
      run: |
        mkdir -p tmp/nscp
      shell: bash

    - name: setup python dependencies
      shell: bash
      run: |
        pip3 install -r build/python/requirements.txt

    - id: tinyxml2
      uses: ./.github/actions/tinyxml2
      with:
        version: ${{ env.TINY_XML_2_VERSION }}

    - id: mongoose
      uses: ./.github/actions/mongoose
      with:
        version: ${{ env.MONGOOSE_VERSION }}

    - id: build-web
      working-directory: web
      run: |
        npm install
        npm run build

    - name: Write NSClient++ cmake config
      run: |
        cat > tmp/nscp/build.cmake << 'EOF'
        SET(LIBRARY_ROOT_FOLDER "${{ env.GITHUB_WORKSPACE }}")
        SET(NSCP_BOOST_PYTHON_VERSION "python313")
        SET(TINY_XML2_SOURCE_DIR "${{ steps.tinyxml2.outputs.path_unix }}")
        set(MONGOOSE_SOURCE_DIR "${{ steps.mongoose.outputs.path_unix }}")
        set(CHECK_NSCLIENT_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}")
        set(USE_STATIC_RUNTIME OFF)
        EOF

    - uses: actions/download-artifact@v7
      with:
        name: check_nsclient-linux-${{ inputs.architecture }}

    - name: CMake (NSCP)
      working-directory: tmp/nscp
      run: |
        cmake ../.. -D BUILD_VERSION=${{ inputs.version }} -D CPACK_GENERATOR=RPM -DCMAKE_BUILD_TYPE=Release

    - name: Build nsclient
      working-directory: tmp/nscp
      run: |
        make

    - name: CPack
      working-directory: tmp/nscp
      run: |
        cpack -G RPM

    - name: rename dist files
      run: |
        mv tmp/nscp/NSCP-${{ inputs.version }}-amd64.rpm NSCP-${{ inputs.version }}-amd64.rpm
      shell: bash

    - name: Test RPM package installation
      run: |
        dnf install -y NSCP-${{ inputs.version }}-amd64.rpm
        nscp settings --load-all --list --add-defaults

    - uses: actions/upload-artifact@v6
      with:
        name: NSCP-${{ inputs.version }}-fedora-x64
        path: |
          NSCP-${{ inputs.version }}-amd64.rpm
        if-no-files-found: error

    - name: Run tests
      working-directory: tmp/nscp
      run: |
        ctest --output-on-failure -C Release
