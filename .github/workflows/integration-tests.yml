name: Integration Tests

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      os:
        type: string
        description: 'Operating system (ubuntu-latest or windows-latest)'
        required: true
      architecture:
        type: string
        description: 'Architecture to test'
        required: true
        default: 'x64'
      version:
        type: string
        description: 'Version to test'
        required: true
      artifact-name:
        type: string
        description: 'Name of the artifact to download'
        required: true
      platform:
        type: string
        description: 'Platform identifier (e.g., x64, Win32, ubuntu-x64)'
        required: true
      package-type:
        type: string
        description: 'Package type (deb, zip)'
        required: true
      run-installer-tests:
        type: boolean
        description: 'Whether to run installer tests (Windows only)'
        required: false
        default: false

env:
  PYTHON_VERSION: 3.11

jobs:
  integration-tests:
    runs-on: ${{ inputs.os }}

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - id: python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ inputs.architecture }}
          cache-dependency-path: 'build/python/requirements.txt'
          cache: 'pip'

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ runner.os == 'Linux' && 'tests/rest/package-lock.json' || 'web/package-lock.json' }}

      - uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact-name }}
          path: .

      # Linux: Install DEB package
      - name: Install DEB package (Linux)
        if: inputs.package-type == 'deb'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-protobuf liblua5.4-0
          sudo apt-get install -y ./NSCP-${{ inputs.version }}-amd64.deb

      # Windows: Extract ZIP archive
      - name: Create folders (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p tmp/nscp
          7z x ../../NSCP-${{ inputs.version }}-${{ inputs.platform }}.zip

      - name: Copy test scripts (Windows)
        if: runner.os == 'Windows'
        working-directory: tmp/nscp
        shell: bash
        run: |
          cp -r ../../scripts/* scripts
          find scripts

      # Linux: Acceptance tests
      - name: Acceptance tests (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo cp -r scripts/* /usr/lib/nsclient/scripts
          sudo nscp nrpe install --certificate --verify none
          ./tests/acceptance-tests.sh

      # Windows: Acceptance tests
      - name: Acceptance tests (Windows)
        if: runner.os == 'Windows'
        working-directory: tmp/nscp
        run: |
          ..\..\tests\acceptance-tests.bat

      - name: Run rest tests
        uses: ./.github/actions/rest-test

      # TODO: Disabled for now due to issues with docker on windows runners
      #- name: Run NRPE tests
      #  working-directory: tmp/nscp
      #  run: |
      #    ..\..\tests\nrpe\run-test.bat

      - name: Run installer tests
        if: runner.os == 'Windows' && inputs.run-installer-tests && inputs.architecture == 'x64'
        uses: ./.github/actions/installer-test

