name: Integration Tests (Linux)

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      container:
        type: string
        description: 'Docker container to use for testing (e.g., fedora:42)'
        required: true
      architecture:
        type: string
        description: 'Architecture to test'
        required: true
        default: 'x64'
      version:
        type: string
        description: 'Version to test'
        required: true
      artifact-name:
        type: string
        description: 'Name of the artifact to download'
        required: true
      package-type:
        type: string
        description: 'Package type (deb, rpm, zip)'
        required: true

env:
  PYTHON_VERSION: 3.11

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container }}

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - id: python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ inputs.architecture }}
          cache-dependency-path: 'build/python/requirements.txt'
          cache: 'pip'

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'tests/rest/package-lock.json'

      - uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact-name }}
          path: .

      # Linux: Install DEB package
      - name: Install DEB package (Linux)
        if: inputs.package-type == 'deb'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-protobuf liblua5.3-0
          sudo apt-get install -y ./NSCP-${{ inputs.version }}-amd64.deb

      # Linux: Install RPM package (Fedora container)
      - name: Install RPM package (Linux)
        if: inputs.package-type == 'rpm'
        shell: bash
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace fedora:42 bash -c "
            dnf install -y python3-devel python3-protobuf /workspace/NSCP-${{ inputs.version }}-amd64.rpm && \
            nscp settings --load-all --list --add-defaults
          "

      # Linux: Acceptance tests (DEB)
      - name: Acceptance tests (Linux DEB)
        if: runner.os == 'Linux' && inputs.package-type == 'deb'
        run: |
          sudo cp -r scripts/* /usr/lib/nsclient/scripts
          sudo nscp nrpe install --certificate --verify none
          ./tests/acceptance-tests.sh

      # Linux: Acceptance tests (RPM in Fedora container)
      - name: Acceptance tests (Linux RPM)
        if: runner.os == 'Linux' && inputs.package-type == 'rpm'
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace fedora:42 bash -c "
            dnf install -y python3-devel python3-protobuf /workspace/NSCP-${{ inputs.version }}-amd64.rpm && \
            cp -r /workspace/scripts/* /usr/lib/nsclient/scripts && \
            nscp nrpe install --certificate --verify none && \
            cd /workspace && \
            ./tests/acceptance-tests.sh
          "

      - name: Run rest tests
        uses: ./.github/actions/rest-test

      # TODO: Disabled for now due to issues with docker on windows runners
      #- name: Run NRPE tests
      #  working-directory: tmp/nscp
      #  run: |
      #    ..\..\tests\nrpe\run-test.bat
