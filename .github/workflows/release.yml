name: Create release

permissions:
  contents: write
  actions: read

on:
  workflow_call:
    inputs:
      version:
        type: string
        description: 'Version to build'
        required: true

env:
  PYTHON_VERSION: 3.11

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true

    - id: python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ ENV.PYTHON_VERSION }}

    # Windows artifacts
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-x64
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-Win32
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-Win32-legacy-xp

    # Ubuntu artifacts
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-ubuntu-20.04-x64
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-ubuntu-22.04-x64
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-ubuntu-24.04-x64

    # Fedora artifacts
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-fedora-40-x64
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-fedora-41-x64
    - uses: actions/download-artifact@v7
      with:
        name: NSCP-${{ inputs.version }}-fedora-42-x64

    - name: Rename docs
      run: |
        mv NSCP-${{ inputs.version }}-x64-docs.zip NSCP-${{ inputs.version }}-docs.zip
        rm NSCP-${{ inputs.version }}-Win32-docs.zip
        rm NSCP-${{ inputs.version }}-Win32-legacy-xp-docs.zip
      shell: pwsh

    - name: Create Release
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ inputs.version }}
        name: ${{ inputs.version }}
        draft: true
        prerelease: false
        generateReleaseNotes: true
        artifacts: |
          NSCP-${{ inputs.version }}-docs.zip
          NSCP-${{ inputs.version }}-x64.zip
          check_nsclient-${{ inputs.version }}-x64.exe
          NSCP-${{ inputs.version }}-Win32.zip
          check_nsclient-${{ inputs.version }}-Win32.exe
          NSCP-${{ inputs.version }}-Win32-legacy-xp.zip
          installers/installer-NSCP/NSCP-${{ inputs.version }}-x64.msi
          installers/installer-NSCP/NSCP-${{ inputs.version }}-Win32.msi
          installers/installer-NSCP/NSCP-${{ inputs.version }}-Win32-legacy-xp.msi
          NSCP-${{ inputs.version }}-x64-symbols.zip
          NSCP-${{ inputs.version }}-Win32-symbols.zip
          NSCP-${{ inputs.version }}-Win32-legacy-xp-symbols.zip
          check_nsclient-${{ inputs.version }}-ubuntu-20.04-x64
          check_nsclient-${{ inputs.version }}-ubuntu-22.04-x64
          check_nsclient-${{ inputs.version }}-ubuntu-24.04-x64
          NSCP-${{ inputs.version }}-ubuntu-20.04-amd64.deb
          NSCP-${{ inputs.version }}-ubuntu-22.04-amd64.deb
          NSCP-${{ inputs.version }}-ubuntu-24.04-amd64.deb
          check_nsclient-${{ inputs.version }}-fedora-40-x64
          check_nsclient-${{ inputs.version }}-fedora-41-x64
          check_nsclient-${{ inputs.version }}-fedora-42-x64
          NSCP-${{ inputs.version }}-fedora-40-amd64.rpm
          NSCP-${{ inputs.version }}-fedora-41-amd64.rpm
          NSCP-${{ inputs.version }}-fedora-42-amd64.rpm
